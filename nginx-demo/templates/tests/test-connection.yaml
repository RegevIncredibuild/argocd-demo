apiVersion: v1
kind: Pod
metadata:
  name: "{{ .Release.Name }}-test-connection"
  labels:
    app: {{ .Release.Name }}
    test: "true"
  annotations:
    # ArgoCD-specific hook for automatic execution
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
    # Keeping Helm hook for compatibility
    "helm.sh/hook": test
    "helm.sh/hook-delete-policy": hook-succeeded
    # Display custom message in events
    argocd.argoproj.io/hook-metadata.message: "Testing connection to {{ .Release.Name }} - Message: {{ .Values.message }}"
spec:
  containers:
    - name: wget
      image: curlimages/curl:7.78.0
      command: ['sh', '-c']
      args:
        - |
          echo "Testing nginx with message: {{ .Values.message }}"
          curl {{ .Release.Name }}:{{ .Values.service.port }}
          echo "Test completed with status: $?"
  restartPolicy: Never
  terminationGracePeriodSeconds: 60
